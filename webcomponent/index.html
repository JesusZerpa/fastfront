<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title></title>

</head>
<body>
	<template 
		name="componente"
		f-data='{"product":"","condicion":false,"elementos":[1,2,3,5]}'
	>
	
		<link 
			rel="import"
			namespace="modulos" 
			src="https://componentes/tarjeta.html"/>
		<style type="text/css">
			
		</style>
		
		<div>
			<f-if :condition="this.condicion">
		 		<button onclick="establecer($id)"></button>
		 	</f-if>
		 	<f-else>
		 		
		 	</f-else>
			<f-for :elemento="this.elementos" > 
				<li ><span>Hola: </span><span>{{elemento}}</span></li>
			</f-for>	
		</div>
		<script >
			export default class Component {

			}
		</script>
	</template>
	<!-- use permite usar los modulos importados por link bajo el grupo de namespace -->
	<f-widget
		use="modulos"
		f-data='{"product":"","texto":"","condicion":false,"elementos":[1,2,3,14],
		"elementos2":[
			{"name":"algo","children":[{"name":"pero"},{"name":"aaa"}]},
			{"name":"algo2","children":[{"name":"pero2"}]},
			{"name":"algo3","children":[{"name":"pero3"}]},
		]}'
	>
		<f-component></f-component>
		
		<f-widget
			use="modulos"
			f-data='{"otra cosa":""}'
		>
		</f-widget>
		<span :style="{'background-color':this.condicion?'red':'blue'}">{{this.condicion?'red':'blue'}}</span>
		<span>{{texto}}</span>
		
		
		<input id="mobileno" type="text" name="" 
				f-model="texto"/>
		<pre>{{elementos2}}</pre>
		<f-for :elemento="this.elementos2">
			<div >
				<span>{{elemento.name}}</span>
				<span>{{elemento}}</span>
				<f-if :condition="this.condicion">
					Activado
				</f-if>
				<f-else>
					Desactivado
				</f-else>
			
				<f-for :elemento2="elemento.children" style="display: block;margin-left: 10px !important;">
					<div :style="{'background-color':this.condicion?'red':'blue'}">
						<span>{{elemento2.name}}</span>
						<button @click="(event)=>{ alert(elemento2.name)}">Presiona</button>
					</div>
				</f-for>
			</div>
		</f-for>
	<span>{{elementos}}</span>
	<button id="boton3" 
            @click="(event) =>{
            	this.elementos2[0].children.push({'name':'nuevo dinamico','children':[]})
            	this.elementos2=this.elementos2;
            	console.log('ccccccccccccccc',this.elementos2)
            }">Presiona</button>
        
		<button
			@click="(event) => { this.condicion=!this.condicion }"
		>
			Hacer click
		</button>
		<button
			@click="(event) => { 
				this.elementos.push(this.elementos.length+1)
				this.elementos=this.elementos
			 }"
		>
			Hacer click
		</button>

		<f-componente f-model:elementos="elementos"></f-componente>

	</f-widget>


 	<script>
 	/*
 	pudo manejar los bucles for como shadow ya que esto me permitiria 
 	que no se listara los subfor al documento queryselector 
 	y igual con los f-if f-elif y f-else 
 	*/
 	let HTMLTAGS=[
		"DIV","SPAN","H1","H4","BUTTON","INPUT","PRE"
	]
 	function dynamic_attr(valor){
		let accept=[]
            
        if (typeof(valor)=="string"){
            accept.push(valor)
        }
        else if (typeof(valor)=="number"){
            accept.push(valor)
        }
        else{
            if (Array.isArray(valor)){
	            for (let elem in valor){

	                if (typeof(elem)=="object"){
	                    for (let attr of elem){
	                    	if (typeof(elem[attr])=='boolean'){
	                    		if (elem[attr]){
		                            accept.push(attr)
		                        }
	                    	}
	                        else{
	                        	accept.push(attr+":"+elem[attr]+";")
		                        
	                        }
	                    }
	                }
	                else if (typeof(elem)=="array"){
	                    accept.extend(elem)
	                }
	                else{
	                    accept.push(elem)
	                }
				}
			}
			else{
				for (let elem in valor){
					if (typeof(valor[elem])=='boolean'){
						accept.push(elem)
					}else{
						accept.push(elem+":"+valor[elem]+";")
					}
				}
			}
		}

		let _valor=accept.join(" ")
		return _valor
 	}

 	function build_context(widget,data,parentContext){
 		/*
 		Los contextos se encargan de actualizar los valores de los atributos de las directivas de sus elementos hijos
 		*/
 		//context={"__data__":None}
	    //data2=Object.assign({"$refs":that.refs,"$stores":that.stores},data)
	    let context={"__data__":data}
	    function builder(widget,name,data,context){

		    
	        function get_func(){

	            return data[name]
	        }
	        function set_func(value){

	            cadena=""
	            data[name]=value
	            if (!Object.keys(widget.nodes).includes(name)){
	            	return
	            }
	            for (let node of widget.nodes[name]){
	            	let nodo=node[0]
	            	let directiva=node[1]
	            	let code=node[2]
	            	let parent=node[3]
	            	let cadena=""
					for (let elem in data){
						cadena+=`let ${elem}=data['${elem}'];`;
						
					}
					
	            	if (nodo.__proto__.constructor.name!="Text" && 
	            		nodo.__proto__.constructor.name!="Comment"){
	            		if (HTMLTAGS.includes(nodo.tagName)){
		            		// atributos span normales
		            		if (directiva==null){
		            			let result=eval("(function(){"+cadena+";return ("+code.slice(2,-2)+")})").call(context)
		            			nodo.innerHTML=result
		            		}else{
		            			let result=eval("(function(){"+cadena+";return ("+code+")})").call(context)
		            			let _valor=dynamic_attr(result)
			            		nodo.setAttribute(
			            			directiva.slice(1,),
			            			_valor
			            			)


		            		}
		            		
		            		
		            	}
		            	else{
		            		//custom elements
		            		let d={}
		            		d[name]=value
		            		console.log("MMMMMMM",nodo,d)
		            		nodo.render(d)
		            		if (nodo.__proto__.constructor.name=="FIf"){
		            			nodo.process()

		            		}
		            	}
	            	}
	            else{
	            	let result=reemplazarValores(code,data)
	            	nodo.nodeValue=result
	            	}
	            }

	            for (let elem of widget.subcomponents){
	            	let reconect=false
	            	for (let model in elem.f_models){
	            		let parent=elem.f_models[model]
	            		if (parent==name){
	            			reconect=true
	            			break
	            		}
	            	}
	            	if (reconect){
	            		elem.connectedCallback()
	            	
	            	}
	            }

	        }
	 		
	 		Object.defineProperty(context,name,{
	            "get":get_func,
	            "set":set_func
	            })

	 	}

	 	for (let name in data){
	 		builder(widget,name,data,context)
	 		
	 	}
	 	return context
 	}
	function reemplazarValores(cadena, datos){
	    //patron = RegExp(r"{{\s*(.*?)\s*}}","g");
	    patron = RegExp("\{\{\s*([^{}.]+(?:\.[^{}.]+)*)\s*\}\}","g");
	    let response
	    
    	function reemplazo(match, p1){

	        clave = p1.trim();
	        if (clave.indexOf(".")>-1 && clave.indexOf("?")==-1){

	            response=datos

	            for (let elem of clave.split(".")){
	            	if (response[elem]!=undefined){
	                    response=response[elem]
	                }
	            }
	                
	            if (typeof(response)=="object"){
	            	response=JSON.stringify(response)
	            }
	                
	            return response
	         }
	        else if(clave.indexOf("[")>-1 || clave.indexOf("?")>-1 || clave.indexOf(":")>-1){
	        	clave=clave.trim()
	        	let cadena2=""
				for (let elem in datos){
					cadena2+=`let ${elem}=datos['${elem}'];`;
					
				}
			
	            result=eval("(function(){"+cadena2+";return "+clave+"})").call(datos)
	            return result
	        }
	            
	        else{
	        	response=datos[clave]
	        }
	        
	        if (response!=undefined){
	            if (typeof(response)=="object"){


	                //Esto se hace para evitar la recursividad al hacer
	                // stringify por el attributo $store

	                response2=Object.assign({},response)

	                //del response2["$stores"]
	                
	                response2=JSON.stringify(response2)
	                return response2
	                }
	            else{
	                return response.toString()
	            }
	        }
	        else{
	            return  "";
	        }
	    }
	    resultado = cadena["replace"](patron, reemplazo);
	    
	    return resultado;
	}
	function travese(nodo,data,localdata,root=null){
		nodo.root=root
		let data2=Object.assign({},data["__data__"],localdata)
					
		for (let elem of nodo.childNodes){
			if (elem.__proto__.constructor.name=="Text"){
				elem._value=elem.nodeValue
				elem.nodeValue=reemplazarValores(elem.nodeValue,data["__data__"])
				for (let key in data2){
					if (elem._value){//este condicional es para evitar procesar cadenas vacias
						let nombreVariableRegex = new RegExp( key + "\\b");

						if (nombreVariableRegex.test(elem._value)){
							if (root.nodes[key]){
								let valid=true
								for (let n of root.nodes[key]){

									if (n[0]==elem ){
										valid=false
										break
									}
								}
								if (valid){
									root.nodes[key].push(
										[elem,null,elem._value,elem.parentNode]
									)
								}
								
								
							}
							else{
								root.nodes[key]=[
										[elem,null,elem._value,elem.parentNode]
									]
								
								
							}
							
						}
					}
				}
			
			}
			
					
		}
		let fif_node
		for (let elem of nodo.children){

			if (elem.processed){
				continue
			}
			if (elem.__proto__.constructor.name=="FIf"){
				if (!root.ifs.includes(elem)){
					root.ifs.push(elem)
				}
				
				fif_node=elem
			}
			if (elem.__proto__.constructor.name=="FELif"){
				fif_node.group.push(elem)
			}

			if (elem.__proto__.constructor.name=="FElse"){
				fif_node.else=elem
			}
			

			if (root){
				elem.root=root
			}
			let is_custom=false;
			if (HTMLTAGS.includes(elem.tagName)
				){

			}
			else if (elem.render){
				is_custom=true
				if (!elem.rendered){
					
					elem.render(localdata)

				}	
				

			}else if(elem.comp){
				is_custom=true
			}
			
			if (elem.children.length==0){
			
				let template
				if (elem._value){
					template=elem._value
				}else{
					template=elem.innerHTML
				}
				if (!elem._value &&template.indexOf("{{")>-1 && template.indexOf("}}")>-1){

					elem._value=template
					
					let compiled=reemplazarValores(elem._value,
						data2)
					
					elem.innerHTML=compiled
					
					for (let key in data2){
						var nombreVariableRegex = new RegExp( key + "\\b");
						
						if (root && nombreVariableRegex.test(elem._value)){
							if (root.nodes[key]){
								let valid=true
								for (let n of root.nodes[key]){

									if (n[0]==elem ){
										valid=false
										break
									}
								}
								if (valid){
									root.nodes[key].push(
										[elem,null,elem._value,elem.parentNode]
									)
								}

								
							}
							else{
								root.nodes[key]=[
										[elem,null,elem._value,elem.parentNode]
									]
								
								
							}
							
						}
					}
				}

				
			}
			let cadena=""
			for (let elem in localdata){
				cadena+=`let ${elem}=localdata['${elem}'];`;
				
			}
			for (let elem in data["__data__"]){
				if (!Object.keys(localdata).includes(elem)){
					cadena+=`let ${elem}=data['${elem}'];`;
				}
				
				
			}
			for (let attr of elem.attributes){

				if (attr.name.startsWith(":")){
					
					
					for (let key in data["__data__"]){

						var nombreVariableRegex = new RegExp( key + "\\b");
						if (root && nombreVariableRegex.test(attr.value)){
							if (root.nodes[key]){
								let valid=true
								for (let n of root.nodes[key]){
							
									if (n[0]==elem && n[1]==attr.name){
										valid=false
										break
									}
								}
								if (is_custom){
									
									
									if (valid){
										root.nodes[key].push(
										[elem,attr.name,attr.value,elem.parent]
										)
									}
									

								}else{
								
									if (valid){
										root.nodes[key].push(
										[elem,attr.name,attr.value,elem.parentNode]
										)
									}
								}
								
							}
							else{
								if (is_custom){
									root.nodes[key]=[
										[elem,attr.name,attr.value,elem.parent]
									]
								}else{
									root.nodes[key]=[
										[elem,attr.name,attr.value,elem.parentNode]
									]
								}
								
								
							}
							
						}
					}
					
					
					if (!is_custom){
						
						let valor=eval("(function(localdata){"+cadena+";return "+attr.value+"})").call(data["__data__"],localdata)
						
						valor=dynamic_attr(valor)		
						elem.setAttribute(attr.name.slice(1,),valor)
						elem.processed=true
				
					}
					
					
					
					//elem.removeAttribute(attr.name)
				}
				if (attr.name=="f-model"){
					function build(context,localdata){
						return function(event){
							let code=event.target.getAttribute(attr.name)
							
							
							c=context
							if (attr.value.indexOf(".")>-1){
								map=attr.value.split(".")
								for (let elem of map.slice(0,-1)){
									c=c[elem]
								}
								c[map[-1]]=event.currentTarget.value
								context[map[0]]=context[map[0]]
							}else{
								context[attr.value]=event.currentTarget.value
							}
							

							console.log("EJECUTANDO2",event.target)

						}
					}
					let fn=build(data,localdata)
					elem.addEventListener("keyup",fn)
					elem.processed=true
				}
				else if(attr.name.startsWith("f-model:")){
					let name=attr.name.replace("f-model:","")
					/*Asumiremos que es un custom component igualmente*/
					elem.f_context=data
					elem.f_localdata=localdata
					let models={}
					models[name]=attr.value
					elem.f_models=models
				}
				if (attr.name.startsWith("@")){
					function build(context,localdata){
						return function(event){
							let code=event.target.getAttribute(attr.name)
							
							let cadena=""
							for (let elem in localdata){
								cadena+=`let ${elem}=localdata['${elem}'];`;
								
							}
							for (let elem in data["__data__"]){
								if (!Object.keys(localdata).includes(elem)){
									cadena+=`let ${elem}=data['${elem}'];`;
								}
								
									
							}
							

							eval("(function(event,localdata){"+cadena+"("+code+")(event)})").call(data,event,localdata)

							console.log("EJECUTANDO",event.target)

						}
					}
					let fn=build(data,localdata)
					elem.addEventListener(attr.name.slice(1,),fn)
					elem.processed=true
				}
			
			
			}
			travese(elem,data,localdata,root)
		}
	}
	function updater(nodo,data,localdata,root=null){
		nodo.root=root
		for (let elem of nodo.childNodes){
			if (elem.__proto__.constructor.name=="Text"){

				elem.nodeValue=reemplazarValores(elem._value,data["__data__"])
			}
		}
		for (let elem of nodo.children){
			if (root){
				elem.root=root
			}
			let is_custom=false;
			if ([
				"DIV","SPAN","H1","H4","BUTTON","INPUT"
				].includes(elem.tagName)
				){


			}
			else{
				is_custom=true
				elem.render(localdata)
			}


			for (let attr of elem.attributes){
				if (attr.name.startsWith(":")){
					for (let key in data["__data__"]){
						var nombreVariableRegex = new RegExp( key + "\\b");
						
						if (nombreVariableRegex.test(attr.value)){
							if (root.nodes[key]){
								if (is_custom){
									root.nodes[key].push(
										[elem,attr.name,attr.value,elem.parent]
									)

								}else{
									root.nodes[key].push(
										[elem,attr.name,attr.value,elem.parentNode]
									)
								}
								
							}
							else{
								if (is_custom){
									root.nodes[key]=[
										[elem,attr.name,attr.value,elem.parent]
									]
								}else{
									root.nodes[key]=[
										[elem,attr.name,attr.value,elem.parentNode]
									]
								}
								
								
							}
							
						}
					}
					
					
					if (!is_custom){
						valor=eval(attr.value)
						elem.setAttribute(attr.name.slice(1,))
				
					}
					
					
					
					//elem.removeAttribute(attr.name)
				}
				if (attr.name.startsWith("@")){
					
				}

			updater(elem,data,localdata,root)
			}
		}
	}
	class HolaMundo extends HTMLElement{
		constructor(){
			super()
		}
		connectedCallback(){
			this.innerHTML="<H1>Hola Mundo con un web Component</H1>"
		}

	}
	class FComponent extends HTMLElement{
		constructor(){
			super()

		}
		connectedCallback(){
			this.outerHTML="<H1>Hola Mundo con un web Component</H1>"
		}
		render(localdata={}){

		}

	}
	class FWidget extends HTMLElement{
		constructor(){
			super()
			this.subcomponents=[]
			if (this.getAttribute("f-data")){
				let data=eval("("+this.getAttribute("f-data")+")")
				this.data=data
				this.nodes={}
				this.context=build_context(this,this.data)
				this.ifs=[]

			}


			
		}
		connectedCallback(){
			//this.outerHTML="<H1>Hola Mundo con un web Component</H1>"
			travese(this,this.context,{},this)
			console.log("sssss",this.ifs)
			for (let if_node of this.ifs){
				if_node.clean()
				if_node.process()
			}


			
		}
		render(localdata={}){
			//Sub widgets
			updater(this,this.context,localdata,this)
			

		}

	}
	class FIf extends HTMLElement{
		constructor(){
			super()

			this.template=this.innerHTML
			this.condition=this.getAttribute(":condition")

			this.parent=this.parentNode
			this.current=this
			this.group=[]
			let start=false

			for (let elem of this.parent.children){
				if (elem==this){
					start=true
				}
				if (start && elem.tagName=="F-ELSE"){
					this.else=elem
					break
				}
			}
			
			
		}
		connectedCallback(){
			
			
		}
		render(localdata={}){
			/*
			this.localdata=localdata
			console.log("uuuuu",localdata)
			

			
			
			this.root.ifs.push(this)

			
			console.log("zzzzzz",localdata)
			
		
			this.rendered=true	
			*/
			
		}
		clean(){
			for (let elem of this.parent.children){

				if (elem.__proto__.constructor.name=="FElse" || elem.__proto__.constructor.name=="FElif"){

					elem.parent.removeChild(elem)
				}
			}		

		}
		process(){
			/*
			Vamos a trabajar la eliminacion de los que no complen la condicion 
			desde una funcion diferente y que sea lanzada por el root despues que termine de renderizar porque 
			*/
			console.log("QQQQQQQQQQQQQ")
			let cadena=""
			for (let elem in this.root.context["__data__"]){
				cadena+=`let ${elem}=this['${elem}'];`;
				
			}

			let valid=eval("(function(){"+cadena+";return "+this.condition+"})").call(this.root.context)
			
			if (this.current && valid){
				console.log("zzzzzz",this.current,this)
				console.log("aaaa",this.parent)
				this.parent.replaceChild(this,this.current)
			}

			if (!valid){
				for (let elem of this.group){
					if (elem.is_valid()){
						valid=true
						this.current=elem
						this.parent.replaceChild(elem,this)
						break
					}
				}
			}
			if (!valid){
				this.current=this.else
				this.parent.replaceChild(this.else,this)
				
			}

			travese(this.current,this.root.context,this.localdata,this.root)
		}
	}
	class FElif extends FIf{
		constructor(){
			super()
		}
	}
	class FElse extends HTMLElement{
		constructor(){
			super()
			this.template=this.innerHTML
			this.parent=this.parentNode
		}
		connectedCallback(){
			if (this.parentNode.condition){
				this.parentNode.remove(this)
			}
		}
		render(localdata={}){
			if (this.parent.condition){
				this.remove()
			}
			else if(this.parentNode==undefined){
				this.parent.appendChild(this)
			}
			this.rendered=true	

		}
	}
	class FFor extends HTMLElement{
		constructor(){
			super()
			this.template=this.innerHTML
			this.parent=this.parentNode
			this.mounted=false
		}
		connectedCallback(){
			

			//this.outerHTML="<H1>Hola Mundo con un web Component</H1>"
			
		}
		attributeChangedCallback(){

		}
		render(localdata={}){
			let iterable={}
			let valor=null
			let name=null
			let cadena=""
			for (let elem in localdata){
				cadena+=`let ${elem}=localdata['${elem}'];`;
				
			}

			for (let elem in this.root.context["__data__"]){
				if (!Object.keys(localdata).includes(elem)){
					cadena+=`let ${elem}=this['${elem}'];`;
				}
				
				
			}
			
			for (let attr of this.attributes){

				if (attr.name.startsWith(":")){
						if (attr.name!=":id" 
							&& attr.name!=":class" 
							&& attr.name!=":style"
							&& attr.name!=":key"){
							
							valor=eval("(function(){"+cadena+";return "+attr.value+"})").call(this.root.data)
							
							name=attr.name.slice(1,)

							break

					}
				}
				
			}
			let template=this.template
			this.innerHTML=""
			let k=0
			
			if (valor){
				for (let elem of valor){
					if (typeof(elem)!="object"){
						eval("let "+name+`=${elem}`)
					}
					else{
						eval("let "+name+"=elem[k]")
					}
					let d=Object.assign({},localdata)
					
					d[name]=elem

					let template_temp=reemplazarValores(template,d)
					let node_template=document.createElement("template")
					
					node_template.innerHTML=template
					this.appendChild(node_template.content)
					travese(this,this.root.context,d,this.root)
					k+=1
						
						
					
					

					
					
				}
			}else if(valor==undefined){
				console.error(`UndefinedValue: ${name}\n`,this,"\n",this.template)
			}
			
			this.mounted=true
			
			
		this.rendered=true	
		}

	}

	window.customElements.define("hola-mundo",HolaMundo)
	//window.customElements.define("f-component",FComponent)
	window.customElements.define("f-for",FFor)
	window.customElements.define("f-if",FIf)
	window.customElements.define("f-else",FElse)
	window.customElements.define("f-widget",FWidget)
	console.log("aaaaaa",document.querySelectorAll("template"))
	for (let nodo of document.querySelectorAll("template")){
		
		// head
		// body
		// script
		console.log("zzzzzzzzz",[nodo])
		let content=null
		let links=[]
		let script=null
		let style=null
		for (let elem of nodo.content.children){
			if (elem.__proto__.constructor.name!="HTMLLinkElement" 
				&& elem.__proto__.constructor.name!="HTMLScriptElement"
				&& elem.__proto__.constructor.name!="HTMLStyleElement"){
				content=elem
				
			}else if (elem.__proto__.constructor.name=="HTMLStyleElement"){
				style=elem
			}else if (elem.__proto__.constructor.name=="HTMLScriptElement"){
				script=elem
			}else if (elem.__proto__.constructor.name=="HTMLLinkElement"){
				links.push(elem)
			}


		}
		let name=nodo.getAttribute("name")
		if (script){
			
			//encontraria el nombre del componente
			let pattern=new RegExp("export\\s+default\\s+class\\s+(\\w+)")
			
			match=script.innerHTML.match(pattern)

			let code=script.innerHTML.replace("export default","")

			let Comp=eval("(function(){"+code+"; return "+match[1]+"})").call()
	

			class Component extends HTMLElement{
				constructor(){
					super()
					console.log("HHHHHH", this.f_context)
					if (nodo.getAttribute("f-data")){
						let data=eval("("+nodo.getAttribute("f-data")+")")
						this.data=data
						this.nodes={}
						this.context=build_context(this,this.data,this.f_context)
						this.ifs=[]

					}
					console.log("lllllll ",nodo,this.data)
					this.template=content.innerHTML
					
					this.parent=this.parentNode
					this.mounted=false
					this.comp=new Comp(this)
					this.root.subcomponents.push(this)

					
					console.log("HHHHHH", this.f_models)

				}
				connectedCallback(){
					this.innerHTML=this.template
					//this.outerHTML="<H1>Hola Mundo con un web Component</H1>"
					if (this.comp.connectedCallback){
						this.comp.connectedCallback()

					}
					for (let elem in this.f_models){
						let parent=this.f_models[elem]

						console.log("ssss",this.data,this.f_context,parent)
						if (parent){
							this.context["__data__"][elem]=this.f_context[parent]
						}
						else{
							this.context["__data__"][elem]=this.f_localdata[parent]

						}
						console.log("mmmmmm",this.context["__data__"],parent,this.f_localdata)
						
					}
					travese(this,this.context,{},this)
					
				}
				attributeChangedCallback(){
					if (this.comp.attributeChangedCallback){
						this.comp.attributeChangedCallback()
					}
					
				}
				render(localdata={}){
					console.log("FFFFFFFFFFFFFFFF",localdata)
					if (this.comp.render){
						this.comp.render(localdata)
					}
					
				}

			}
			
			console.log("VVVVVVVVVV ","f-"+name)
			window.customElements.define("f-"+name,Component)
		}

	}

</script>

</body>
</html>