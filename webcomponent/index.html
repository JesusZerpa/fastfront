<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title></title>

</head>
<body>
	<template name="componente"
		f-data='{"product":"","condicion":true,"elementos":[1,2,3,4]}'
	>
		<head>
			<link 
			rel="import"
			namespace="modulos" 
			src="https://componentes/tarjeta.html">
		
		</head>
		<body>
			<f-if :condition="this.condicion">
		 		<button onclick="establecer($id)"></button>
		 	</f-if>
		 	<f-else>
		 		
		 	</f-else>
			<f-for :elemento="self.elementos" > 
				<li >{{elemento}}</li>
			</f-for>	
		</body>
		
	</template>
	<!-- use permite usar los modulos importados por link bajo el grupo de namespace -->
	<f-widget
		use="modulos"
		f-data='{"product":"","texto":"","condicion":true,"elementos":[1,2,3,4]}'
	>
		<f-component></f-component>
		<f-if :condition="this.condicion">
			Activado
		</f-if>
		<f-widget
			use="modulos"
			f-data='{"otra cosa":""}'
		>
		</f-widget>
		<span :style="{'background-color':this.condicion?'red':'blue'}">{{this.condicion?'red':'blue'}}</span>
		<span>{{texto}}</span>
		
		<f-else>
			Desactivado
		</f-else>
		<input id="mobileno" type="text" name="" 
				f-model="texto"/>
		<f-for :elemento="self.elementos">
			<div >
				<input id="mobileno" type="text" name="" 
				f-model="texto"/>
			</div>
		</f-for>

		<button
			@click="(event) => { console.log('oooo',this);this.condicion=!this.condicion }"
		>
			Hacer click
		</button>

	</f-widget>


 	<script>
 	/*
 	pudo manejar los bucles for como shadow ya que esto me permitiria 
 	que no se listara los subfor al documento queryselector 
 	y igual con los f-if f-elif y f-else 
 	*/
 	let HTMLTAGS=[
		"DIV","SPAN","H1","H4","BUTTON","INPUT"
	]
 	function dynamic_attr(valor){
		let accept=[]
            
        if (typeof(valor)=="string"){
            accept.push(valor)
        }
        else if (typeof(valor)=="number"){
            accept.push(valor)
        }
        else{
            if (Array.isArray(valor)){
	            for (let elem in valor){

	                if (typeof(elem)=="object"){
	                    for (let attr of elem){
	                    	if (typeof(elem[attr])=='boolean'){
	                    		if (elem[attr]){
		                            accept.push(attr)
		                        }
	                    	}
	                        else{
	                        	accept.push(attr+":"+elem[attr]+";")
		                        
	                        }
	                    }
	                }
	                else if (typeof(elem)=="array"){
	                    accept.extend(elem)
	                }
	                else{
	                    accept.push(elem)
	                }
				}
			}
			else{
				for (let elem in valor){
					if (typeof(valor[elem])=='boolean'){
						accept.push(elem)
					}else{
						accept.push(elem+":"+valor[elem]+";")
					}
				}
			}
		}

		let _valor=accept.join(" ")
		return _valor
 	}

 	function build_context(widget,data){
 		/*
 		Los contextos se encargan de actualizar los valores de los atributos de las directivas de sus elementos hijos
 		*/
 		//context={"__data__":None}
	    //data2=Object.assign({"$refs":that.refs,"$stores":that.stores},data)
	    let context={"__data__":data}
	    function builder(widget,name,data,context){

		    
	        function get_func(){

	            return data[name]
	        }
	        function set_func(value){

	            cadena=""
	            data[name]=value
	            console.log("++++++++",widget.nodes,name,context)
	            for (let node of widget.nodes[name]){
	            	let nodo=node[0]
	            	let directiva=node[1]
	            	let code=node[2]
	            	let parent=node[3]
	            	let cadena=""
					for (let elem in data){
						cadena+=`let ${elem}=data['${elem}'];`;
						
					}
					
	            	if (nodo.__proto__.constructor.name!="Text" && 
	            		nodo.__proto__.constructor.name!="Comment"){
	            		if (HTMLTAGS.includes(nodo.tagName)){
		            		// atributos span normales
		            		if (directiva==null){
		            			console.log("WWWWWWW ","(function(){"+cadena+";return ("+code.slice(2,-2)+")})")
		            			let result=eval("(function(){"+cadena+";return ("+code.slice(2,-2)+")})").call(context)
		            			nodo.innerHTML=result
		            		}else{
		            			let result=eval("(function(){"+cadena+";return ("+code+")})").call(context)
		            			let _valor=dynamic_attr(result)
			            		nodo.setAttribute(
			            			directiva.slice(1,),
			            			_valor
			            			)


		            		}
		            		
		            		
		            	}
		            	else{
		            		//custom elements
		            		console.log("Sssss",[nodo])
		            		nodo.render()
		            	}
	            	}
	            else{
	            	let result=reemplazarValores(code,data)
	            	console.log("wwwwww ",node,result,data)
	            	nodo.nodeValue=result
	            	}
	            }
	        }
	 		
	 		Object.defineProperty(context,name,{
	            "get":get_func,
	            "set":set_func
	            })

	 	}

	 	for (let name in data){
	 		builder(widget,name,data,context)
	 		
	 	}
	 	return context
 	}
	function reemplazarValores(cadena, datos){
	    //patron = RegExp(r"{{\s*(.*?)\s*}}","g");
	    patron = RegExp("\{\{\s*([^{}.]+(?:\.[^{}.]+)*)\s*\}\}","g");
	    let response
	    
    	function reemplazo(match, p1){
    		console.log("kkkkkk ",cadena)
	        clave = p1.trim();
	        if (clave.indexOf(".")>-1 && clave.indexOf("?")==-1){
	        	console.log("EEEEEEEEEEEEEEEEE",cadena)
	            response=datos

	            for (let elem of clave.split(".")){
	            	if (response[elem]!=undefined){
	                    response=response[elem]
	                }
	            }
	                
	            if (typeof(response)=="object"){
	            	response=JSON.stringify(response)
	            }
	                
	            return response
	         }
	        else if(clave.indexOf("[")>-1 || clave.indexOf("?")>-1 || clave.indexOf(":")>-1){
	        	clave=clave.trim()
	        	console.log("*********************",cadena,clave)
	        	let cadena2=""
				for (let elem in datos){
					cadena2+=`let ${elem}=datos['${elem}'];`;
					
				}
			
	            result=eval("(function(){"+cadena2+";return "+clave+"})").call(datos)
	            return result
	        }
	            
	        else{
	        	console.log("mmmm",cadena,clave,datos)
	        	response=datos[clave]
	        }
	        
	        if (response!=undefined){
	            if (typeof(response)=="object"){


	                //Esto se hace para evitar la recursividad al hacer
	                // stringify por el attributo $store

	                response2=Object.assign({},response)

	                //del response2["$stores"]
	                
	                response2=JSON.stringify(response2)
	                return response2
	                }
	            else{
	                return response.toString()
	            }
	        }
	        else{
	            return  "";
	        }
	    }
	    resultado = cadena["replace"](patron, reemplazo);
	    
	    return resultado;
	}
	function travese(nodo,data,localdata,root=null){
		nodo.root=root
		for (let elem of nodo.childNodes){
			if (elem.__proto__.constructor.name=="Text"){
				elem._value=elem.nodeValue
				elem.nodeValue=reemplazarValores(elem.nodeValue,data["__data__"])
				for (let key in data["__data__"]){
					if (elem._value.includes(key)){
						if (root.nodes[key]){
							root.nodes[key].push(
									[elem,null,elem._value,elem.parentNode]
								)
							
						}
						else{
							root.nodes[key]=[
									[elem,null,elem._value,elem.parentNode]
								]
							
							
						}
						
					}
				}
			
			}
			
					
		}
		for (let elem of nodo.children){
			if (root){
				elem.root=root
			}
			let is_custom=false;
			if (HTMLTAGS.includes(elem.tagName)
				){

			}
			else{
				is_custom=true
				elem.render()
			}
			console.log("yyyyy",elem)
			if (elem.children.length==0){
				if (elem.innerHTML.indexOf("{{")>-1 && elem.innerHTML.indexOf("}}")>-1){
					elem._value=elem.innerHTML
					elem.innerHTML=reemplazarValores(elem._value,data["__data__"])
					for (let key in data["__data__"]){
						if (elem._value.includes(key)){
							if (root.nodes[key]){
								root.nodes[key].push(
										[elem,null,elem._value,elem.parentNode]
									)
								
							}
							else{
								root.nodes[key]=[
										[elem,null,elem._value,elem.parentNode]
									]
								
								
							}
							
						}
					}
				}
				
			}

			for (let attr of elem.attributes){

				if (attr.name.startsWith(":")){
					for (let key in data["__data__"]){
						if (attr.value.includes(key)){
							if (root.nodes[key]){
								if (is_custom){
									root.nodes[key].push(
										[elem,attr.name,attr.value,elem.parent]
									)

								}else{
									root.nodes[key].push(
										[elem,attr.name,attr.value,elem.parentNode]
									)
								}
								
							}
							else{
								if (is_custom){
									root.nodes[key]=[
										[elem,attr.name,attr.value,elem.parent]
									]
								}else{
									root.nodes[key]=[
										[elem,attr.name,attr.value,elem.parentNode]
									]
								}
								
								
							}
							
						}
					}
					
					
					if (!is_custom){
						let valor=eval("("+attr.value+")")
						valor=dynamic_attr(valor)		
						elem.setAttribute(attr.name.slice(1,),valor)
				
					}
					
					
					
					//elem.removeAttribute(attr.name)
				}
				if (attr.name=="f-model"){
					console.log("SSSSSS",elem)
					function build(context,localdata){
						return function(event){
							let code=event.target.getAttribute(attr.name)
							
							let cadena=""
							for (let elem in data["__data__"]){
								cadena+=`let ${elem}=data['${elem}'];`;
								
							}
							for (let elem in localdata){
								cadena+=`let ${elem}=localdata['${elem}'];`;
								
							}
							console.log("DDDDDDDDDDDDDDDDD")
							c=context
							if (attr.value.indexOf(".")>-1){
								map=attr.value.split(".")
								for (let elem of map.slice(0,-1)){
									c=c[elem]
								}
								c[map[-1]]=event.currentTarget.value
								context[map[0]]=context[map[0]]
							}else{
								context[attr.value]=event.currentTarget.value
							}
							

							console.log("EJECUTANDO2",event.target)

						}
					}
					let fn=build(data,localdata)
					elem.addEventListener("keyup",fn)
				}
				if (attr.name.startsWith("@")){
					function build(context,localdata){
						return function(event){
							let code=event.target.getAttribute(attr.name)
							
							let cadena=""
							for (let elem in data["__data__"]){
								cadena+=`let ${elem}=data['${elem}'];`;
								
							}
							for (let elem in localdata){
								cadena+=`let ${elem}=localdata['${elem}'];`;
								
							}
							eval("(function(event,localdata){"+cadena+"("+code+")(event)})").call(data,event,localdata)

							console.log("EJECUTANDO",event.target)

						}
					}
					let fn=build(data,localdata)
					elem.addEventListener(attr.name.slice(1,),fn)
				}
			
			
			}
			console.log("ffffff",is_custom,elem)
			if (!is_custom){
				travese(elem,data,localdata,root)
			}
		}
	}
	function updater(nodo,data,localdata,root=null){
		nodo.root=root
		console.log("UUUUUUUUUUUUUUUUU",nodo)
		for (let elem of nodo.childNodes){
			if (elem.__proto__.constructor.name=="Text"){
				console.log("WWWWWWWW ",elem._value)
				elem.nodeValue=reemplazarValores(elem._value,data["__data__"])
			}
		}
		for (let elem of nodo.children){
			if (root){
				elem.root=root
			}
			let is_custom=false;
			if ([
				"DIV","SPAN","H1","H4","BUTTON","INPUT"
				].includes(elem.tagName)
				){

			}
			else{
				is_custom=true
				elem.render()
			}


			for (let attr of elem.attributes){
				if (attr.name.startsWith(":")){
					for (let key in data["__data__"]){
						if (attr.value.includes(key)){
							if (root.nodes[key]){
								if (is_custom){
									root.nodes[key].push(
										[elem,attr.name,attr.value,elem.parent]
									)

								}else{
									root.nodes[key].push(
										[elem,attr.name,attr.value,elem.parentNode]
									)
								}
								
							}
							else{
								if (is_custom){
									root.nodes[key]=[
										[elem,attr.name,attr.value,elem.parent]
									]
								}else{
									root.nodes[key]=[
										[elem,attr.name,attr.value,elem.parentNode]
									]
								}
								
								
							}
							
						}
					}
					
					
					if (!is_custom){
						valor=eval(attr.value)
						elem.setAttribute(attr.name.slice(1,))
				
					}
					
					
					
					//elem.removeAttribute(attr.name)
				}
				if (attr.name.startsWith("@")){
					
				}

			updater(elem,data,localdata,root)
			}
		}
	}
	class HolaMundo extends HTMLElement{
		constructor(){
			super()
		}
		connectedCallback(){
			this.innerHTML="<H1>Hola Mundo con un web Component</H1>"
		}

	}
	class FComponent extends HTMLElement{
		constructor(){
			super()

		}
		connectedCallback(){
			this.outerHTML="<H1>Hola Mundo con un web Component</H1>"
		}
		render(){

		}

	}
	class FWidget extends HTMLElement{
		constructor(){
			super()
			if (this.getAttribute("f-data")){
				let data=eval("("+this.getAttribute("f-data")+")")
				this.data=data
				this.nodes={}
				this.context=build_context(this,this.data)

			}


			
		}
		connectedCallback(){
			//this.outerHTML="<H1>Hola Mundo con un web Component</H1>"
			travese(this,this.context,{},this)


			
		}
		render(){
			updater(this,this.context,{},this)

		}

	}
	class FIf extends HTMLElement{
		constructor(){
			super()

			this.template=this.innerHTML
			this.condition=this.getAttribute(":condition")

			this.parent=this.parentNode
			let start=false
			for (let elem of this.parent.children){
				if (elem==this){
					start=true
				}
				if (start && elem.tagName=="F-ELSE"){
					this.else=elem
					break
				}
			}
			
			
		}
		connectedCallback(){
			
			
		}
		render(){
			let cadena=""
			for (let elem in this.root.context["__data__"]){
				cadena+=`let ${elem}=this['${elem}'];`;
				
			}
			let valid=eval("(function(){"+cadena+";return "+this.condition+"})").call(this.root.context)

			this.parent.condition=valid
			if (this.parentNode==undefined){
				//significa que hemos comprobado la condicion anterior mente
				if (valid){
					this.parent.appendChild(this)	
				}

			}
			else{
				if (!valid){
					this.parentNode.removeChild(this)
				}
				else{
					
					this.parent.appendChild(this)
				}
			}
			this.else.render()
			
		}
	}
	class FElif extends FIf{
		constructor(){
			super()
		}
	}
	class FElse extends HTMLElement{
		constructor(){
			super()
			this.template=this.innerHTML
			this.parent=this.parentNode
		}
		connectedCallback(){
			if (this.parentNode.condition){
				this.parentNode.remove(this)
			}
		}
		render(){
			if (this.parent.condition){
				this.remove()
			}
			else if(this.parentNode==undefined){
				this.parent.appendChild(this)
			}

		}
	}
	class FFor extends HTMLElement{
		constructor(){
			super()
			this.template=this.innerHTML
			this.parent=this.parentNode
			this.mounted=false
		}
		connectedCallback(){
			

			//this.outerHTML="<H1>Hola Mundo con un web Component</H1>"
			
		}
		attributeChangedCallback(){

		}
		render(){
			let iterable={}
			let valor=null
			let name=null
			for (let attr of this.attributes){

				if (attr.name.startsWith(":")){
						if (attr.name!=":id" 
							&& attr.name!=":class" 
							&& attr.name!=":style"
							&& attr.name!=":key"){
							valor=eval("((self)=>{ return "+attr.value+"})").call(null,this.root.data)
							
							name=attr.name.slice(1,)

							break

					}
				}
				
			}
			let template=this.innerHTML
			this.innerHTML=""
			for (let elem in valor){
				if (typeof(elem)!="object"){
					eval("let "+name+`=${elem}`)
				}
				else{
					eval("let "+name+"="+elem)
				}
				let d={}
				d[name]=elem

				let template_temp=reemplazarValores(template,d)
				let node_template=document.createElement("template")
				
				node_template.innerHTML=template_temp
				
				if (this.mounted){
					updater(node_template.content,this.root.context,d)
				}
				else{
					console.log("HHHHHHHHHHHHHHHHHHH")
					travese(node_template.content,this.root.context,d)
					
				}
				

				this.appendChild(node_template.content)
				
			}
			this.mounted=true
			if (document.querySelector("input")){
				console.log("FOCUS")
				document.querySelector("input").focus()
			}
			
			
		}

	}

	window.customElements.define("hola-mundo",HolaMundo)
	window.customElements.define("f-component",FComponent)
	window.customElements.define("f-for",FFor)
	window.customElements.define("f-if",FIf)
	window.customElements.define("f-else",FElse)
	window.customElements.define("f-widget",FWidget)

</script>

</body>
</html>